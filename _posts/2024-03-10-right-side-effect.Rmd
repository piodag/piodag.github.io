---
title: "Right side effect and bias in MethComp"
author: "Dr Giorgio Pioda"
date: "2024-02-10"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = F,message = F,error = F,
                      fig.width = 12,fig.height = 8)
source("../snippet/rs.eff.R")
source("../snippet/euler_slope_Equi.R")
library(readr)
library(knitr)
```


```{r, run2im1, fig.cap="Power analysis, Deming vs Passing Bablok"}
defcomp100st2vs2Jack4r2.r <- as.data.frame(read_csv("../data_set/defcomp100st2vs2Jack4r2.csv"))

p.plotcompleto(defcomp100st2vs2Jack4r2.r,"slope","d.tot",sigma.st = 0.03,
               main="Two digits (2x2) precision, 3 - 8 short range data set, 1000 randomizations/point",lty=1,pch=1)
p.plotcompleto(defcomp100st2vs2Jack4r2.r,"slope","p.tot",pch=2,add=T,col="black",sigma.st = 0.03,lty=2)
p.plotcompleto(defcomp100st2vs2Jack4r2.r,"slope","pc.tot",pch=3,add=T,col="black",sigma.st = 0.03,lty=4)
p.plotcompleto(defcomp100st2vs2Jack4r2.r,"slope","pa.tot",pch=16,add=T,col="blue",sigma.st = 0.03,lty=1)
p.plotcompleto(defcomp100st2vs2Jack4r2.r,"slope","pf.tot",pch=17,add=T,col="blue",sigma.st = 0.03,lty=2)
p.plotcompleto(defcomp100st2vs2Jack4r2.r,"slope","po.tot",pch=18,add=T,col="purple",sigma.st = 0.03,lty=4)

abline(v=1,lty=2)

legend("topleft",legend=c("Dem - bootstrapped BCa CI5%",
                           "Dem - anal. CI5%",
                           "Dem - jack. CI5%",
                           "PBequi - anal. CI5%",
                           "PBequi - anal. methodlarge=F CI5%",
                           "PaBa - anal. CI5%"
),
title="Methods",
pch=c(1,2,3,16,17,18),
col=c("black","black","black","blue","blue","purple"),
text.col = c("black","black","black","blue","blue","purple"),
lty=c(1,2,4,1,2,4)
)
```


A new experiment (at 2x2 digit precision) was carried out to reproduce and confirm the bias of the various Passing Bablok methods. It was chosen to increase the resolution in the tails: one point for every 0.002 units in the interval [0.9;1.1] for a total of 109 points. Each point consists of aproportion over 1000 regressions. The Deming - jackknife method was added as additional reference to the list.

The Deming bootstrap BCa method is again shown to be particularly symmetric. The Deming analytic and jackknife methods are very similar to each other, with a slight **right-side effect (r.s.e)**. The power curves of the three Deming methods look anyway very similar. A very light asymmetry can be understood as the effect of the fact that the slopes distribution is not perfectly normal. Only testing for the angles (tangent methods) should provide perfectly symmetric power curves. Anyway each model is tested with the very same data set. Thus the comparison between methods is definitely meaningful, and Deming methods are a good standard to start with.

Unfortunately, the asymmetry of the Passing Bablok methods is confirmed. The classical algorithm is completely unacceptable. For the two PBequi variants the situation is much better, but cannot be called good. In fact, the r.s.e stands at 3.8% for the methodlarge=F variant and 4.8% for the default variant. Basically, there is a bias and an increased probability of not rejecting slopes greater than 1 compared to slopes less than 1.

```{r, table_rse }
curve<-c("p.tot","pc.tot","d.tot",
         "pa.tot","pf.tot","po.tot",
         "md.tot","mmd.tot","d.e100")

c.nomi<-c("Deming - anal.","Deming - jack.","Deming - boot BCa",
          "PBequi - anal.", "PBequi methodlarge=F - anal.","PaBa - anal.",
          "MDeming - jack.", "MMDeming - jack.", "Deming - JE MD 1%")

rse.st2x2.j4r2<-matrix(NA,ncol=2,nrow=9)

for (i in 1:9){
  rs <- rs.eff(defcomp100st2vs2Jack4r2.r,"slope",curve[i])
  rse.st2x2.j4r2[i,] <- rs
}

rse.st2x2.j4r2<-as.data.frame(rse.st2x2.j4r2)
colnames(rse.st2x2.j4r2)<-c("r. s. vol. ratio","r.s.e %")
rownames(rse.st2x2.j4r2)<-c.nomi

kable(rse.st2x2.j4r2,align="c",caption="Table of r.s.e.")
```

Below is reported a plot for the M and MM- Deming methods. These methods are slightly more conservative.

```{r, run2im2, fig.cap="Power analysis, M-Deming MM-Deming and JE / Mahalanobis distances"}

p.plotcompleto(defcomp100st2vs2Jack4r2.r,"slope","d.tot",sigma.st = 0.03,
               main="Two digits (2x2) precision, 3 - 8 short range data set, 1000 randomizations/point",lty=1,pch=1)
p.plotcompleto(defcomp100st2vs2Jack4r2.r,"slope","pc.tot",pch=3,add=T,col="black",sigma.st = 0.03,lty=4)
p.plotcompleto(defcomp100st2vs2Jack4r2.r,"slope","d.e100",pch=4,add=T,col="black",sigma.st = 0.03,lty=2)

p.plotcompleto(defcomp100st2vs2Jack4r2.r,"slope","md.tot",pch=18,add=T,col="red",sigma.st = 0.03,lty=1)
p.plotcompleto(defcomp100st2vs2Jack4r2.r,"slope","mmd.tot",pch=19,add=T,col="orange",sigma.st = 0.03,lty=2)

legend("topleft",legend=c( "Dem - bootstrapped BCa CI5%",
                           "Dem - jack. CI5%",
                           "Dem - JE MD CI1%",
                           "MDem - jack. CI5%",
                           "MMDem - anal. CI5%"
),
title="Methods",
pch=c(1,3,4,18,19),
col=c("black","black","black","red","orange"),
text.col = c("black","black","black","red","orange"),
lty=c(1,4,2,1,2)
)

```


M- and MM-Deming are more symmetrical than the Passing Bablok methods. For MDeming jackknife the r.s.e value is just slight higher than that of the reference Deming jackknife variant. For MMDeming, on the other hand, there is an higher value which is still lower than those recorded by the nonparametric methods.

Finally the Deming test performed with Mahalanobis Distances (JE MD) at 1% shows r.s.e and asymmetry very similar to the Deming analytical and jackknife methods.


